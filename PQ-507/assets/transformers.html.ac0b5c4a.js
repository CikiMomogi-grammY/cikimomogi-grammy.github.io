import{_ as l,r as c,o as r,c as u,b as a,a as s,w as e,d as n,e as o}from"./app.9837a88d.js";const d={},m=s("h1",{id:"bot-api-transformers",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#bot-api-transformers","aria-hidden":"true"},"#"),n(" Bot API Transformers")],-1),h=s("p",null,"Middleware is a function that handles a context object, i.e. incoming data.",-1),k=s("p",null,[n("grammY also provides you with the inverse. A "),s("em",null,"transformer function"),n(" is a function that handles outgoing data, i.e.")],-1),f=s("ul",null,[s("li",null,"a method name of the Bot API to call, and"),s("li",null,"a payload object that matches the method.")],-1),b=n("Instead of having "),v=s("code",null,"next",-1),g=n(" as the last argument to invoke downstream middleware, you receive "),_=s("code",null,"prev",-1),y=n(" as the first argument to utilize upstream transformer functions. Looking at the type signature of "),w=s("code",null,"Transformer",-1),x=n(" ("),I={href:"https://doc.deno.land/https://deno.land/x/grammy/mod.ts/~/Transformer",target:"_blank",rel:"noopener noreferrer"},A=n("grammY API Reference"),P=n("), we can see how it reflects that. Note that "),T=s("code",null,[n("Payload<M"),s("wbr"),n(", R>")],-1),j=n(" refers to the payload object that has to match the given method, and that "),q=s("code",null,[n("Api"),s("wbr"),n("Response<Api"),s("wbr"),n("Call"),s("wbr"),n("Result<M"),s("wbr"),n(", R>>")],-1),C=n(" is the return type of the invoked method."),F=o(`<p>The last invoked transformer function is a built-in caller that does things like JSON serialization of certain fields, and eventually calling <code>fetch</code>.</p><p>There is no equivalent of a <code>Composer</code> class for transformer functions because that\u2019s probably overkill, but if you need it, you can write your own. PR welcome! \u{1F609}</p><h2 id="installing-a-transformer-function" tabindex="-1"><a class="header-anchor" href="#installing-a-transformer-function" aria-hidden="true">#</a> Installing a Transformer Function</h2><p>Transformer functions can be installed on <code>bot<wbr>.api</code>. Here is an example for a transformer function that does nothing:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// Pass-through transformer function</span>
bot<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> method<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> signal<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">prev</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> signal<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Comparison with pass-through middleware</span>
bot<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Here is an example of a transformer function that prevents all API calls from happening:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// Incorrectly return undefined instead of the respective object types.</span>
bot<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> method<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>You can also install transformer functions on the context object\u2019s API object. The transformer function will then only be used temporarily for the API requests that are performed on that specific context object. Calls to <code>bot<wbr>.api</code> are left unaffected. Calls via context objects of concurrently running middleware are left unaffected, as well. As soon as the respective middleware completes, the transformer function is discarded.</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Install on all context objects that process messages.</span>
  ctx<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> method<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> signal<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">prev</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> signal<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>The <code>signal</code> parameter should be always passed to <code>prev</code>. It allows canceling requests and is important for <code>bot<wbr>.stop</code> to work.</p></blockquote><p>Transformer functions installed on <code>bot<wbr>.api</code> will be pre-installed on every <code>ctx<wbr>.api</code> object. Thus, calls to <code>ctx<wbr>.api</code> will be transformed by both those transformers on <code>ctx<wbr>.api</code>, as well as those transformers installed on <code>bot<wbr>.api</code>.</p><h2 id="use-cases-of-transformer-functions" tabindex="-1"><a class="header-anchor" href="#use-cases-of-transformer-functions" aria-hidden="true">#</a> Use Cases of Transformer Functions</h2><p>Transformer functions are as flexible as middleware, and they have just as many different applications.</p>`,13),R=n("For instance, the "),Y=n("grammY menu plugin"),E=n(" installs a transformer function to turn outgoing menu instances into the correct payload. You can also use them to"),N=n("implement "),M=n("flood control"),z=n(","),S=s("li",null,"mock API requests during testing,",-1),B=n("add "),D=n("retry behavior"),L=n(", or"),H=s("li",null,"more.",-1),K=o('<p>Note, however, that retrying an API call can have odd side-effects: if you call <code>send<wbr>Document</code> and pass a readable stream instance to <code>Input<wbr>File</code>, then the stream will be read the first time the request is tried. If you invoke <code>prev</code> again, the stream may already be (partially) consumed, hence leading to broken files. It is therefore a more reliable way to pass file paths to <code>Input<wbr>File</code>, so grammY can recreate the stream as necessary.</p><h2 id="api-flavoring" tabindex="-1"><a class="header-anchor" href="#api-flavoring" aria-hidden="true">#</a> API Flavoring</h2>',2),O=n("grammY features "),V=n("context flavors"),U=o(" that can be used to adjust the context type. This includes API methods\u2014both those that are directly on the context object such as <code>ctx<wbr>.reply</code>, and all methods in <code>ctx<wbr>.api</code> and <code>ctx<wbr>.api<wbr>.raw</code>. However, you cannot adjust the types of <code>bot<wbr>.api</code> and <code>bot<wbr>.api<wbr>.raw</code> via context flavors.",11),G=o(`<p>This is why grammY supports <em>API flavors</em>. They solve this problem:</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Api<span class="token punctuation">,</span> Bot<span class="token punctuation">,</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;grammy&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SomeApiFlavor<span class="token punctuation">,</span> SomeContextFlavor<span class="token punctuation">,</span> somePlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;some-plugin&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Context flavoring</span>
<span class="token keyword">type</span> <span class="token class-name">MyContext</span> <span class="token operator">=</span> Context <span class="token operator">&amp;</span> SomeContextFlavor<span class="token punctuation">;</span>
<span class="token comment">// API flavoring</span>
<span class="token keyword">type</span> <span class="token class-name">MyApi</span> <span class="token operator">=</span> Api <span class="token operator">&amp;</span> SomeApiFlavor<span class="token punctuation">;</span>

<span class="token comment">// Use both flavors.</span>
<span class="token keyword">const</span> bot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bot<span class="token operator">&lt;</span>MyContext<span class="token punctuation">,</span> MyApi<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;my-token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Use a plugin.</span>
bot<span class="token punctuation">.</span>api<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">somePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Now call \`bot.api\` with adjusted types from API flavor.</span>
bot<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">somePluginMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Also, use adjusted context type from context flavor.</span>
bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">somePluginMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),J=n("API flavors work exactly analogously to context flavors. There are both additive and transformative API flavors, and multiple API flavors can be combined the same way as you would do with context flavors. If you are unsure how this works, head back to the "),Q=n("section about context flavors"),W=n(" in the guide.");function X(Z,$){const i=c("AutotagPage"),p=c("ExternalLinkIcon"),t=c("RouterLink");return r(),u("div",null,[m,a(i,{config:'[{"url":["/plugins"],"exclude":["console-time","middlewares","autoquote","guide","session","keyboard","/"],"tag":[{"template":"official","text":"OFFICIAL","desc":"This plugin is published and maintained by grammY","locale":{"es":{"text":"OFICIAL","desc":"Este plugin es publicado y mantenido por grammY"},"id":{"text":"RESMI","desc":"Plugin ini dipublikasi dan dikelola oleh grammY"},"zh":{"text":"\u5B98\u65B9\u7EF4\u62A4","desc":"\u8FD9\u4E2A\u63D2\u4EF6\u662F\u7531grammY\u53D1\u5E03\u548C\u7EF4\u62A4\u7684"}}}]},{"url":["/plugins"],"include":["console-time","middlewares","autoquote"],"tag":[{"template":"thirdparty","text":"THIRD-PARTY","desc":"This plugin is maintained by third-party","locale":{"es":{"text":"DE TERCEROS","desc":"Este plugin es mantenido por terceros"},"id":{"text":"PIHAK KETIGA","desc":"Plugin ini dikelola oleh pihak ketiga"},"zh":{"text":"\u7B2C\u4E09\u65B9","desc":"\u8FD9\u4E2A\u63D2\u4EF6\u662F\u7531\u7B2C\u4E09\u65B9\u7EF4\u62A4\u7684"}}}]},{"url":["/hosting"],"exclude":["gcf","comparison"],"tag":[{"template":"deno","desc":"This setup is able to run Deno bots","locale":{"es":{"desc":"Esta configuraci\xF3n es capaz de ejecutar bots Deno"},"id":{"desc":"Konfigurasi ini dapat dijalankan di bot Deno"},"zh":{"desc":"\u8FD9\u4E2A\u8BBE\u7F6E\u80FD\u591F\u8FD0\u884CDeno\u673A\u5668\u4EBA"}}}]},{"url":["/hosting"],"include":["heroku","vps"],"tag":[{"template":"nodejs","desc":"This setup is able to run Node.js bots","locale":{"es":{"desc":"Esta configuraci\xF3n es capaz de ejecutar bots Node.js"},"id":{"desc":"Konfigurasi ini dapat dijalankan di bot Node.js"},"zh":{"desc":"\u8FD9\u4E2A\u8BBE\u7F6E\u80FD\u591F\u8FD0\u884CNode.js\u673A\u5668\u4EBA"}}}]}]'}),h,k,f,s("p",null,[b,v,g,_,y,w,x,s("a",I,[A,a(p)]),P,T,j,q,C]),F,s("p",null,[R,a(t,{to:"/plugins/menu.html"},{default:e(()=>[Y]),_:1}),E]),s("ul",null,[s("li",null,[N,a(t,{to:"/plugins/transformer-throttler.html"},{default:e(()=>[M]),_:1}),z]),S,s("li",null,[B,a(t,{to:"/plugins/auto-retry.html"},{default:e(()=>[D]),_:1}),L]),H]),K,s("p",null,[O,a(t,{to:"/guide/context.html#context-flavors"},{default:e(()=>[V]),_:1}),U]),G,s("p",null,[J,a(t,{to:"/guide/context.html#context-flavors"},{default:e(()=>[Q]),_:1}),W])])}const sn=l(d,[["render",X],["__file","transformers.html.vue"]]);export{sn as default};
