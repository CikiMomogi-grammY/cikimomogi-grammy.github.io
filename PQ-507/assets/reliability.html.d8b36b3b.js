import{_ as p,r as c,o as r,c as d,b as t,a as n,w as e,d as s,e as k}from"./app.9a621f1c.js";const h={},m=n("h1",{id:"scaling-up-iii-reliability",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#scaling-up-iii-reliability","aria-hidden":"true"},"#"),s(" Scaling Up III: Reliability")],-1),g=s("If you made sure you have proper "),b=s("error handling"),_=s(" for your bot, you are basically good to go. All errors that should be expected to happen (failing API calls, failing network requests, failing database queries, failing middleware, etc) are all caught."),f=n("p",null,[s("You should make sure to always "),n("code",null,"await"),s(" all promises, or at least call "),n("code",null,"catch"),s(" on them if you ever don\u2019t want to "),n("code",null,"await"),s(" stuff. Use a linting rule to make sure you cannot forget this.")],-1),y=n("h2",{id:"graceful-shutdown",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#graceful-shutdown","aria-hidden":"true"},"#"),s(" Graceful Shutdown")],-1),v=s("For bots that are using long polling, there is one more thing to consider. As you are going to stop your instance during operation at some point again, you should consider catching "),w=n("code",null,"SIGTERM",-1),I=s(" and "),x=n("code",null,"SIGINT",-1),T=s(" events, and call "),S=n("code",null,[s("bot"),n("wbr"),s(".stop")],-1),R=s(" (built-in long polling) or stop your bot via its "),G={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/RunnerHandle#stop",target:"_blank",rel:"noopener noreferrer"},N=s("handle"),j=s(" (grammY runner):"),E=n("h3",{id:"simple-long-polling",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#simple-long-polling","aria-hidden":"true"},"#"),s(" Simple Long Polling")],-1),Y=n("div",{class:"language-typescript ext-ts line-numbers-mode"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" Bot "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},'"grammy"'),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" bot "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// Stopping the bot when the Node process"),s(`
`),n("span",{class:"token comment"},"// is about to be terminated"),s(`
process`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGINT"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
process`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGTERM"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"await"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"start"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),B=n("div",{class:"language-javascript ext-js line-numbers-mode"},[n("pre",{class:"language-javascript"},[n("code",null,[n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token punctuation"},"{"),s(" Bot "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"require"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"grammy"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" bot "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// Stopping the bot when the Node process"),s(`
`),n("span",{class:"token comment"},"// is about to be terminated"),s(`
process`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGINT"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
process`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGTERM"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"await"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"start"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),q=n("div",{class:"language-typescript ext-ts line-numbers-mode"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" Bot "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},'"https://deno.land/x/grammy@v1.11.1/mod.ts"'),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" bot "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// Stopping the bot when the Deno process"),s(`
`),n("span",{class:"token comment"},"// is about to be terminated"),s(`
Deno`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"addSignalListener"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGINT"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
Deno`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"addSignalListener"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGTERM"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"await"),s(" bot"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"start"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),D=n("h3",{id:"using-grammy-runner",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#using-grammy-runner","aria-hidden":"true"},"#"),s(" Using grammY runner")],-1),A=n("div",{class:"language-typescript ext-ts line-numbers-mode"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" Bot "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},'"grammy"'),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" run "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},'"@grammyjs/runner"'),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" bot "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" runner "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),s("bot"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// Stopping the bot when the Node process"),s(`
`),n("span",{class:"token comment"},"// is about to be terminated"),s(`
`),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token function-variable function"},"stopRunner"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" runner"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"isRunning"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(" runner"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
process`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGINT"'),n("span",{class:"token punctuation"},","),s(" stopRunner"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
process`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGTERM"'),n("span",{class:"token punctuation"},","),s(" stopRunner"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),L=n("div",{class:"language-javascript ext-js line-numbers-mode"},[n("pre",{class:"language-javascript"},[n("code",null,[n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token punctuation"},"{"),s(" Bot "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"require"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"grammy"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token punctuation"},"{"),s(" run "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"require"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"@grammyjs/runner"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" bot "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" runner "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),s("bot"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// Stopping the bot when the Node process"),s(`
`),n("span",{class:"token comment"},"// is about to be terminated"),s(`
`),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token function-variable function"},"stopRunner"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" runner"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"isRunning"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(" runner"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
process`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGINT"'),n("span",{class:"token punctuation"},","),s(" stopRunner"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
process`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"once"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGTERM"'),n("span",{class:"token punctuation"},","),s(" stopRunner"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),P=n("div",{class:"language-typescript ext-ts line-numbers-mode"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" Bot "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},'"https://deno.land/x/grammy@v1.11.1/mod.ts"'),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"import"),s(),n("span",{class:"token punctuation"},"{"),s(" run "),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"from"),s(),n("span",{class:"token string"},'"https://deno.land/x/grammy_runner@v1.0.4/mod.ts"'),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" bot "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"const"),s(" runner "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),s("bot"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// Stopping the bot when the Deno process"),s(`
`),n("span",{class:"token comment"},"// is about to be terminated"),s(`
`),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token function-variable function"},"stopRunner"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(" runner"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"isRunning"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(" runner"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"stop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
Deno`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"addSignalListener"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGINT"'),n("span",{class:"token punctuation"},","),s(" stopRunner"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
Deno`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"addSignalListener"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"SIGTERM"'),n("span",{class:"token punctuation"},","),s(" stopRunner"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),C=n("p",null,"That\u2019s basically all there is to reliability, your instance should\xAE\uFE0F never\u2122\uFE0F crash now.",-1),M=n("h2",{id:"reliability-guarantees",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#reliability-guarantees","aria-hidden":"true"},"#"),s(" Reliability Guarantees")],-1),U=s("What if your bot is processing financial transactions and you must consider a "),z={href:"https://stackoverflow.com/questions/43724467/what-is-the-difference-between-kill-and-kill-9",target:"_blank",rel:"noopener noreferrer"},H=n("code",null,[s("kill "),n("wbr"),s("-9")],-1),K=s(" scenario"),O=s(" where the CPU physically breaks or there is a power outage in the data center? If for some reason someone or something actually hard-kills the process, it gets a bit more complicated."),F=s("In essence, bots cannot guarantee an "),V=n("em",null,"exactly once",-1),J=s(" execution of your middleware. Read "),W={href:"https://github.com/tdlib/telegram-bot-api/issues/126",target:"_blank",rel:"noopener noreferrer"},Q=s("this discussion on Git"),X=n("wbr",null,null,-1),Z=s("Hub"),$=s(" in order to learn more about "),nn=n("strong",null,"why",-1),sn=s(" your bot could send duplicate messages (or none at all) in extremely rare cases. The remainder of this section is elaborating on "),tn=n("strong",null,"how",-1),en=s(" grammY behaves under these unusual circumstances, and how to handle these situations."),an=s("Do you just care about coding a Telegram bot? "),on=s("Skip the rest of this page"),cn=n("wbr",null,null,-1),ln=s("."),un=k('<h3 id="webhook" tabindex="-1"><a class="header-anchor" href="#webhook" aria-hidden="true">#</a> Webhook</h3><p>If you are running your bot on webhooks, the Bot API server will retry delivering updates to your bot if it does not respond with <code>OK</code> in time. That pretty much defines the behavior of the system comprehensively\u2014if you need to prevent processing duplicate updates, you should build your own de-duplication based on <code>update<wbr>_id</code>. grammY does not do this for you, but feel free to PR if you think someone else could profit from this.</p><h3 id="long-polling" tabindex="-1"><a class="header-anchor" href="#long-polling" aria-hidden="true">#</a> Long Polling</h3><p>Long polling is more interesting. The built-in polling basically re-runs the most recent update batch that was fetched but could not complete.</p>',4),pn=s("Note that if you properly stop your bot with "),rn=n("code",null,[s("bot"),n("wbr"),s(".stop")],-1),dn=s(", "),kn={href:"https://core.telegram.org/bots/api#getting-updates",target:"_blank",rel:"noopener noreferrer"},hn=s("the update offset"),mn=s(" will be synced with the Telegram servers by calling "),gn=n("code",null,[s("get"),n("wbr"),s("Updates")],-1),bn=s(" with the correct offset but without processing the update data."),_n=n("p",null,[s("In other words, you will never loose any updates, however, it may happen that you re-process up to 100 updates that you have seen before. As calls to "),n("code",null,[s("send"),n("wbr"),s("Message")]),s(" are not idempotent, users may receive duplicate messages from your bot. However, "),n("em",null,"at least once"),s(" processing is guaranteed.")],-1),fn=n("h3",{id:"grammy-runner",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#grammy-runner","aria-hidden":"true"},"#"),s(" grammY Runner")],-1),yn=s("If you are using the "),vn=s("grammY runner"),wn=s(" in concurrent mode, the next "),In=n("code",null,[s("get"),n("wbr"),s("Updates")],-1),xn=s(" call is potentially performed before your middleware processes the first update of the current batch. Thus, the update offset is "),Tn={href:"https://core.telegram.org/bots/api#getupdates",target:"_blank",rel:"noopener noreferrer"},Sn=s("confirmed"),Rn=s(" prematurely. This is the cost of heavy concurrency, and unfortunately, it cannot be avoided without reducing both throughput and responsiveness. As a result, if your instance is killed in the right (wrong) moment, it could happen that up to 100 updates cannot be fetched again because Telegram regards them as confirmed. This leads to data loss."),Gn=n("p",null,"If it is crucial to prevent this, you should use the sources and sinks of the grammY runner package to compose your own update pipeline that passes all updates through a message queue first.",-1),Nn=s("You\u2019d basically have to create a "),jn={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/UpdateSink",target:"_blank",rel:"noopener noreferrer"},En=s("sink"),Yn=s(" that pushes to the queue, and start one runner that only supplies your message queue."),Bn=s("You\u2019d then have to create a "),qn={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/UpdateSource",target:"_blank",rel:"noopener noreferrer"},Dn=s("source"),An=s(" that pulls from the message queue again. You will effectively run two different instances of the grammY runner."),Ln=s("This vague draft described above has only been sketched but not implemented, according to our knowledge. Please "),Pn={href:"https://t.me/grammyjs",target:"_blank",rel:"noopener noreferrer"},Cn=s("take contact with the Telegram group"),Mn=s(" if you have any question or if you attempt this and can share your progress."),Un=s("On the other hand, if your bot is under heavy load and the update polling is slowed down due to the "),zn=s("automatic load constraints"),Hn=s(", chances are increasing that some updates will be fetched again, which leads to duplicate messages again. Thus, the price of full concurrency is that neither "),Kn=n("em",null,"at least once",-1),On=s(" nor "),Fn=n("em",null,"at most once",-1),Vn=s(" processing can be guaranteed.");function Jn(Wn,Qn){const u=c("AutotagPage"),i=c("RouterLink"),a=c("ExternalLinkIcon"),o=c("CodeGroupItem"),l=c("CodeGroup");return r(),d("div",null,[m,t(u,{config:'[{"url":["/plugins"],"exclude":["console-time","middlewares","autoquote","guide","session","keyboard","/"],"tag":[{"template":"official","text":"OFFICIAL","desc":"This plugin is published and maintained by grammY","locale":{"es":{"text":"OFICIAL","desc":"Este plugin es publicado y mantenido por grammY"},"id":{"text":"RESMI","desc":"Plugin ini dipublikasi dan dikelola oleh grammY"},"zh":{"text":"\u5B98\u65B9\u7EF4\u62A4","desc":"\u8FD9\u4E2A\u63D2\u4EF6\u662F\u7531grammY\u53D1\u5E03\u548C\u7EF4\u62A4\u7684"}}}]},{"url":["/plugins"],"include":["console-time","middlewares","autoquote"],"tag":[{"template":"thirdparty","text":"THIRD-PARTY","desc":"This plugin is maintained by third-party","locale":{"es":{"text":"DE TERCEROS","desc":"Este plugin es mantenido por terceros"},"id":{"text":"PIHAK KETIGA","desc":"Plugin ini dikelola oleh pihak ketiga"},"zh":{"text":"\u7B2C\u4E09\u65B9","desc":"\u8FD9\u4E2A\u63D2\u4EF6\u662F\u7531\u7B2C\u4E09\u65B9\u7EF4\u62A4\u7684"}}}]},{"url":["/hosting"],"exclude":["gcf","comparison"],"tag":[{"template":"deno","desc":"This setup is able to run Deno bots","locale":{"es":{"desc":"Esta configuraci\xF3n es capaz de ejecutar bots Deno"},"id":{"desc":"Konfigurasi ini dapat dijalankan di bot Deno"},"zh":{"desc":"\u8FD9\u4E2A\u8BBE\u7F6E\u80FD\u591F\u8FD0\u884CDeno\u673A\u5668\u4EBA"}}}]},{"url":["/hosting"],"include":["heroku","vps"],"tag":[{"template":"nodejs","desc":"This setup is able to run Node.js bots","locale":{"es":{"desc":"Esta configuraci\xF3n es capaz de ejecutar bots Node.js"},"id":{"desc":"Konfigurasi ini dapat dijalankan di bot Node.js"},"zh":{"desc":"\u8FD9\u4E2A\u8BBE\u7F6E\u80FD\u591F\u8FD0\u884CNode.js\u673A\u5668\u4EBA"}}}]}]'}),n("p",null,[g,t(i,{to:"/guide/errors.html"},{default:e(()=>[b]),_:1}),_]),f,y,n("p",null,[v,w,I,x,T,S,R,n("a",G,[N,t(a)]),j]),E,t(l,null,{default:e(()=>[t(o,{title:"TypeScript",active:""},{default:e(()=>[Y]),_:1}),t(o,{title:"JavaScript"},{default:e(()=>[B]),_:1}),t(o,{title:"Deno"},{default:e(()=>[q]),_:1})]),_:1}),D,t(l,null,{default:e(()=>[t(o,{title:"TypeScript",active:""},{default:e(()=>[A]),_:1}),t(o,{title:"JavaScript"},{default:e(()=>[L]),_:1}),t(o,{title:"Deno"},{default:e(()=>[P]),_:1})]),_:1}),C,M,n("p",null,[U,n("a",z,[H,K,t(a)]),O]),n("p",null,[F,V,J,n("a",W,[Q,X,Z,t(a)]),$,nn,sn,tn,en]),n("blockquote",null,[n("p",null,[an,t(i,{to:"/advanced/flood.html"},{default:e(()=>[on,cn,ln]),_:1})])]),un,n("blockquote",null,[n("p",null,[pn,rn,dn,n("a",kn,[hn,t(a)]),mn,gn,bn])]),_n,fn,n("p",null,[yn,t(i,{to:"/plugins/runner.html"},{default:e(()=>[vn]),_:1}),wn,In,xn,n("a",Tn,[Sn,t(a)]),Rn]),Gn,n("ol",null,[n("li",null,[Nn,n("a",jn,[En,t(a)]),Yn]),n("li",null,[Bn,n("a",qn,[Dn,t(a)]),An])]),n("p",null,[Ln,n("a",Pn,[Cn,t(a)]),Mn]),n("p",null,[Un,t(i,{to:"/plugins/runner.html#sink"},{default:e(()=>[zn]),_:1}),Hn,Kn,On,Fn,Vn])])}const Zn=p(h,[["render",Jn],["__file","reliability.html.vue"]]);export{Zn as default};
