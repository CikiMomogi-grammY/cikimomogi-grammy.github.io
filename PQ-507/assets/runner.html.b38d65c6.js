import{_ as u,r,o as p,c as d,a as n,b as s,w as a,d as e,e as c}from"./app.59a23fc3.js";const h={},m=n("h1",{id:"concurrency-with-grammy-runner-runner",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#concurrency-with-grammy-runner-runner","aria-hidden":"true"},"#"),e(" Concurrency With grammY runner ("),n("code",null,"runner"),e(")")],-1),k=e("This package can be used if you run your bot "),_=e("using long polling"),g=e(", and you want messages to be processed concurrently."),b=e("Make sure to understand "),f=e("Scaling Up II"),y=e(" before you use grammY runner."),w=n("h2",{id:"why-we-need-a-bot-runner",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#why-we-need-a-bot-runner","aria-hidden":"true"},"#"),e(" Why We Need a Bot Runner")],-1),v=n("p",null,"If you are hosting your bot using long polling and you want to make it scale up, there is no way around processing updates concurrently as sequential update processing is way too slow. As a result, bots face a number of challenges.",-1),x=n("ul",null,[n("li",null,"Are there race conditions?"),n("li",null,[e("Can we still "),n("code",null,"await"),e(" the middleware stack? We must have this for error handling!")]),n("li",null,"What if middleware never resolves for some reason, does this block the bot?"),n("li",null,"Can we constrain the server load?")],-1),I=e("As you can see, we need a solution that can solve all of the above problems to achieve proper long polling for a bot. This is a problem that is very distinct from composing middleware or sending messages to Telegram. Consequently, it is not solved by the grammY core package. Instead, you can use "),T={href:"https://github.com/grammyjs/runner",target:"_blank",rel:"noopener noreferrer"},A=e("grammY runner"),q=e(". It has its own "),C={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts",target:"_blank",rel:"noopener noreferrer"},S=e("API Reference"),B=e(", too."),R=n("h2",{id:"usage",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#usage","aria-hidden":"true"},"#"),e(" Usage")],-1),Y=n("p",null,"Here is a simple example.",-1),P=n("div",{class:"language-typescript ext-ts line-numbers-mode"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"import"),e(),n("span",{class:"token punctuation"},"{"),e(" Bot "),n("span",{class:"token punctuation"},"}"),e(),n("span",{class:"token keyword"},"from"),e(),n("span",{class:"token string"},'"grammy"'),n("span",{class:"token punctuation"},";"),e(`
`),n("span",{class:"token keyword"},"import"),e(),n("span",{class:"token punctuation"},"{"),e(" run "),n("span",{class:"token punctuation"},"}"),e(),n("span",{class:"token keyword"},"from"),e(),n("span",{class:"token string"},'"@grammyjs/runner"'),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Create a bot."),e(`
`),n("span",{class:"token keyword"},"const"),e(" bot "),n("span",{class:"token operator"},"="),e(),n("span",{class:"token keyword"},"new"),e(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Add the usual middleware, yada yada"),e(`
bot`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"on"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"message"'),n("span",{class:"token punctuation"},","),e(),n("span",{class:"token punctuation"},"("),e("ctx"),n("span",{class:"token punctuation"},")"),e(),n("span",{class:"token operator"},"=>"),e(" ctx"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"reply"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Got your message."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Run it concurrently!"),e(`
`),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),e("bot"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),U=n("div",{class:"language-typescript ext-ts line-numbers-mode"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"const"),e(),n("span",{class:"token punctuation"},"{"),e(" Bot "),n("span",{class:"token punctuation"},"}"),e(),n("span",{class:"token operator"},"="),e(),n("span",{class:"token keyword"},"require"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"grammy"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`
`),n("span",{class:"token keyword"},"const"),e(),n("span",{class:"token punctuation"},"{"),e(" run "),n("span",{class:"token punctuation"},"}"),e(),n("span",{class:"token operator"},"="),e(),n("span",{class:"token keyword"},"require"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"@grammyjs/runner"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Create a bot."),e(`
`),n("span",{class:"token keyword"},"const"),e(" bot "),n("span",{class:"token operator"},"="),e(),n("span",{class:"token keyword"},"new"),e(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Add the usual middleware, yada yada"),e(`
bot`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"on"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"message"'),n("span",{class:"token punctuation"},","),e(),n("span",{class:"token punctuation"},"("),e("ctx"),n("span",{class:"token punctuation"},")"),e(),n("span",{class:"token operator"},"=>"),e(" ctx"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"reply"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Got your message."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Run it concurrently!"),e(`
`),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),e("bot"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),W=n("div",{class:"language-typescript ext-ts line-numbers-mode"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"import"),e(),n("span",{class:"token punctuation"},"{"),e(" Bot "),n("span",{class:"token punctuation"},"}"),e(),n("span",{class:"token keyword"},"from"),e(),n("span",{class:"token string"},'"https://deno.land/x/grammy@v1.11.1/mod.ts"'),n("span",{class:"token punctuation"},";"),e(`
`),n("span",{class:"token keyword"},"import"),e(),n("span",{class:"token punctuation"},"{"),e(" run "),n("span",{class:"token punctuation"},"}"),e(),n("span",{class:"token keyword"},"from"),e(),n("span",{class:"token string"},'"https://deno.land/x/grammy_runner@v1.0.4/mod.ts"'),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Create a bot."),e(`
`),n("span",{class:"token keyword"},"const"),e(" bot "),n("span",{class:"token operator"},"="),e(),n("span",{class:"token keyword"},"new"),e(),n("span",{class:"token class-name"},"Bot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"<token>"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Add the usual middleware, yada yada"),e(`
bot`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"on"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"message"'),n("span",{class:"token punctuation"},","),e(),n("span",{class:"token punctuation"},"("),e("ctx"),n("span",{class:"token punctuation"},")"),e(),n("span",{class:"token operator"},"=>"),e(" ctx"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"reply"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Got your message."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`

`),n("span",{class:"token comment"},"// Run it concurrently!"),e(`
`),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),e("bot"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),e(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),G=c(`<p>Of course, while this looks very simple, a lot is going on under the hood.</p><h2 id="how-it-works-behind-the-scenes" tabindex="-1"><a class="header-anchor" href="#how-it-works-behind-the-scenes" aria-hidden="true">#</a> How It Works Behind the Scenes</h2><p>Every runner consists of three different parts.</p><ol><li>The <strong>source</strong> pulls in updates from Telegram.</li><li>The <strong>sink</strong> supplies the bot instance with updates.</li><li>The <strong>runner</strong> component connects source and sink, and allows you to start and stop your bot.</li></ol><div class="language-asciiart ext-asciiart"><pre class="language-asciiart"><code>api.telegram.org &lt;\u2014&gt; source &lt;\u2014&gt; runner &lt;\u2014&gt; sink &lt;\u2014&gt; bot
</code></pre></div><h3 id="source" tabindex="-1"><a class="header-anchor" href="#source" aria-hidden="true">#</a> Source</h3>`,6),N=e("grammY runner ships with one default source that can operate on any "),j=n("code",null,[e("Update"),n("wbr"),e("Supplier")],-1),H=e(" ("),E={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/UpdateSupplier",target:"_blank",rel:"noopener noreferrer"},L=e("API reference"),V=e("). Such an update supplier is straightforward to create from a bot instance. If you want make one yourself, be sure to check out "),z=n("code",null,[e("create"),n("wbr"),e("Update"),n("wbr"),e("Fetcher")],-1),D=e(" ("),F={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/createUpdateFetcher",target:"_blank",rel:"noopener noreferrer"},O=e("API reference"),M=e(")."),J=n("p",null,[e("The source is an async iterator of update batches, but it can be active or inactive, and you can "),n("code",null,"close"),e(" it in order to disconnect from the Telegram servers.")],-1),K=n("h3",{id:"sink",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#sink","aria-hidden":"true"},"#"),e(" Sink")],-1),Q=e("grammY runner ships with three possible sink implementations, a sequential one (same behavior as "),X=n("code",null,[e("bot"),n("wbr"),e(".start()")],-1),Z=e("), a batched one (mainly useful for backwards compatibility with other frameworks), and a fully concurrent one (used by "),$=n("code",null,"run",-1),nn=e("). All of them operate on "),en=n("code",null,[e("Update"),n("wbr"),e("Consumer")],-1),sn=e(" objects ("),tn={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/UpdateConsumer",target:"_blank",rel:"noopener noreferrer"},an=e("API reference"),on=e(") which are straightforward to create from a bot instance. If you want make one yourself, be sure to check out "),rn=n("code",null,[e("handle"),n("wbr"),e("Update")],-1),cn=e(" on the "),ln=n("code",null,"Bot",-1),un=e(" instance of grammY ("),pn={href:"https://doc.deno.land/https://deno.land/x/grammy/mod.ts/~/Bot#handleUpdate",target:"_blank",rel:"noopener noreferrer"},dn=e("API reference"),hn=e(")."),mn=e("The sink contains a queue ("),kn={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/DecayingDeque",target:"_blank",rel:"noopener noreferrer"},_n=e("API reference"),gn=e(") of individual updates that are currently being processed. Adding new updates to the queue will immediately make the update consumer handle them, and return a promise that resolves as soon as there is capacity in the queue again. The resolved integral number determines the free space. Setting a concurrency limit for the grammY runner is therefore respected through the underlying queue instance."),bn=c('<p>The queue also throws out updates that take too long processing, and you can specify a <code>timeout<wbr>Handler</code> when creating the respective sink. Of course, you should also provide an error handler when creating a sink.</p><p>If you\u2019re using <code>run(bot)</code>, the error handler from <code>bot<wbr>.catch</code> will be used.</p><h3 id="runner" tabindex="-1"><a class="header-anchor" href="#runner" aria-hidden="true">#</a> Runner</h3><p>The runner is a plain loop that pulls in updates from the source and supplies them to the sink. Once the sink has space again, the runner will fetch the next batch of updates from the source.</p>',4),fn=e("When you create a runner with "),yn=n("code",null,[e("create"),n("wbr"),e("Runner")],-1),wn=e(" ("),vn={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/createRunner",target:"_blank",rel:"noopener noreferrer"},xn=e("API reference"),In=e("), you obtain a handle that you can use to control the runner. For instance, it allows you start and stop it, or obtain a promise that resolves if the runner stops. (This handle is also returned by "),Tn=n("code",null,"run",-1),An=e(".) Check out the "),qn={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts/~/RunnerHandle",target:"_blank",rel:"noopener noreferrer"},Cn=e("API reference"),Sn=e(" of the "),Bn=n("code",null,[e("Runner"),n("wbr"),e("Handle")],-1),Rn=e("."),Yn=n("h2",{id:"sequential-processing-where-necessary",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#sequential-processing-where-necessary","aria-hidden":"true"},"#"),e(" Sequential Processing Where Necessary")],-1),Pn=e("Most likely, you want to be guaranteed that messages from the same chat are processed in order. This is useful when installing "),Un=e("session middleware"),Wn=e(", but it also makes sure that your bot does not confuse the order of messages in the same chat."),Gn=e("grammY runner exports the "),Nn=n("code",null,"sequentialize",-1),jn=e(" middleware that takes care of this. You can check out "),Hn=e("this section"),En=e(" to learn how to use it."),Ln=c(`<p>We are now going to look at more advanced usage of the plugin.</p><p>The supplied constraint function can be used not only to specify chat identifier, or user identifier. Instead, you can return <em>a list of constraint identifier strings</em> that determine for every update individually what other computations it must wait for before processing can begin.</p><p>As an example, you could return both the chat identifier, and the user identifier of the message author.</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>bot<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">sequentialize</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> chat <span class="token operator">=</span> ctx<span class="token punctuation">.</span>chat<span class="token operator">?.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> ctx<span class="token punctuation">.</span>from<span class="token operator">?.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>chat<span class="token punctuation">,</span> user<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> con <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This would make sure that messages in the same chat are ordered correctly. In addition, if Alice sends message in a group, and then sends a message to your bot in the private chat, then these two messages are ordered correctly.</p><p>In a sense, you can therefore specify a graph of dependencies between updates. grammY runner will resolve all necessary constraints on the fly and block those updates as long as necessary to ensure correct message ordering.</p><p>The implementation of this is very efficient. It needs constant memory (unless you specify infinite concurrency), and it needs (amortized) constant processing time per update.</p><h2 id="graceful-shutdown" tabindex="-1"><a class="header-anchor" href="#graceful-shutdown" aria-hidden="true">#</a> Graceful shutdown</h2>`,8),Vn=e("In order for the bot to complete it\u2019s work correctly you "),zn=e("should signal"),Dn=e(" it to stop when the process is about to be destroyed."),Fn=n("h2",{id:"plugin-summary",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#plugin-summary","aria-hidden":"true"},"#"),e(" Plugin Summary")],-1),On=n("li",null,[e("Name: "),n("code",null,"runner")],-1),Mn=e("Source: "),Jn={href:"https://github.com/grammyjs/runner",target:"_blank",rel:"noopener noreferrer"},Kn=e("https://"),Qn=n("wbr",null,null,-1),Xn=e("github"),Zn=n("wbr",null,null,-1),$n=e(".com"),ne=n("wbr",null,null,-1),ee=e("/grammyjs"),se=n("wbr",null,null,-1),te=e("/runner"),ae=e("Reference: "),oe={href:"https://doc.deno.land/https://deno.land/x/grammy_runner/mod.ts",target:"_blank",rel:"noopener noreferrer"},re=c("https://<wbr>doc<wbr>.deno<wbr>.land<wbr>/https://<wbr>deno<wbr>.land<wbr>/x<wbr>/grammy<wbr>_runner<wbr>/mod<wbr>.ts",23);function ce(ie,le){const o=r("RouterLink"),t=r("ExternalLinkIcon"),i=r("CodeGroupItem"),l=r("CodeGroup");return p(),d("div",null,[m,n("p",null,[k,s(o,{to:"/guide/deployment-types.html"},{default:a(()=>[_]),_:1}),g]),n("blockquote",null,[n("p",null,[b,s(o,{to:"/advanced/scaling.html#long-polling"},{default:a(()=>[f]),_:1}),y])]),w,v,x,n("p",null,[I,n("a",T,[A,s(t)]),q,n("a",C,[S,s(t)]),B]),R,Y,s(l,null,{default:a(()=>[s(i,{title:"TypeScript",active:""},{default:a(()=>[P]),_:1}),s(i,{title:"JavaScript"},{default:a(()=>[U]),_:1}),s(i,{title:"Deno"},{default:a(()=>[W]),_:1})]),_:1}),G,n("p",null,[N,j,H,n("a",E,[L,s(t)]),V,z,D,n("a",F,[O,s(t)]),M]),J,K,n("p",null,[Q,X,Z,$,nn,en,sn,n("a",tn,[an,s(t)]),on,rn,cn,ln,un,n("a",pn,[dn,s(t)]),hn]),n("p",null,[mn,n("a",kn,[_n,s(t)]),gn]),bn,n("p",null,[fn,yn,wn,n("a",vn,[xn,s(t)]),In,Tn,An,n("a",qn,[Cn,s(t)]),Sn,Bn,Rn]),Yn,n("p",null,[Pn,s(o,{to:"/plugins/session.html"},{default:a(()=>[Un]),_:1}),Wn]),n("p",null,[Gn,Nn,jn,s(o,{to:"/advanced/scaling.html#concurrency-is-hard"},{default:a(()=>[Hn]),_:1}),En]),Ln,n("p",null,[Vn,s(o,{to:"/advanced/reliability.html#using-grammy-runner"},{default:a(()=>[zn]),_:1}),Dn]),Fn,n("ul",null,[On,n("li",null,[Mn,n("a",Jn,[Kn,Qn,Xn,Zn,$n,ne,ee,se,te,s(t)])]),n("li",null,[ae,n("a",oe,[re,s(t)])])])])}const pe=u(h,[["render",ce],["__file","runner.html.vue"]]);export{pe as default};
